<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalTab ç®¡ç†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      color: #60a5fa;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      color: #60a5fa;
    }

    .scan-btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .scan-btn:hover {
      background: #2563eb;
    }

    .scan-btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }

    .scan-btn.scanning .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .ports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .port-item {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s;
    }

    .port-item:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .port-number {
      font-size: 20px;
      font-weight: bold;
      color: #10b981;
    }

    .port-info {
      font-size: 11px;
      color: #888;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .port-process {
      color: #60a5fa;
    }

    .port-title {
      font-size: 12px;
      color: #10b981;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .port-actions {
      display: flex;
      gap: 6px;
    }

    .port-btn {
      background: #1a4a7a;
      border: none;
      color: #eee;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      flex: 1;
      transition: all 0.2s;
    }

    .port-btn:hover {
      background: #3b82f6;
    }

    .port-btn.add {
      background: #10b981;
    }

    .port-btn.add:hover {
      background: #34d399;
    }

    .empty-state {
      text-align: center;
      color: #666;
      padding: 40px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    .status-dot.offline {
      background: #ef4444;
    }

    .custom-scan {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #0f3460;
    }

    .custom-input {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      width: 100px;
    }

    .custom-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #16213e;
      border: 1px solid #4ade80;
      color: #eee;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .link-to-main {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #60a5fa;
      text-decoration: none;
      font-size: 13px;
      margin-bottom: 20px;
    }

    .link-to-main:hover {
      text-decoration: underline;
    }

    .api-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 8px 12px;
      background: #0f3460;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="link-to-main">â† è¿”å›è¦–çª—åˆ†å‰²å™¨</a>

    <h1>ğŸ”§ LocalTab ç®¡ç†</h1>

    <div class="card">
      <div class="card-header">
        <span class="card-title">API ç‹€æ…‹</span>
        <div class="api-status" id="apiStatus">
          <span class="status-dot offline"></span>
          <span>æª¢æŸ¥ä¸­...</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">é–‹å•Ÿçš„ç«¯å£</span>
        <button class="scan-btn" onclick="scanPorts()" id="scanBtn">
          <span class="spinner">â†»</span> æƒæç«¯å£
        </button>
      </div>

      <div class="ports-grid" id="portsGrid">
        <div class="empty-state">é»æ“Šã€Œæƒæç«¯å£ã€é–‹å§‹</div>
      </div>

      <div class="custom-scan">
        <button class="scan-btn" onclick="scanAllPorts()">é¡¯ç¤ºæ‰€æœ‰ç«¯å£</button>
        <span style="color: #666; font-size: 12px; margin-left: 8px;">åŒ…å«ç³»çµ±æœå‹™</span>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">å¿«é€Ÿæ–°å¢</span>
      </div>
      <div style="display: flex; gap: 8px;">
        <input type="text" class="custom-input" id="quickUrl" placeholder="è¼¸å…¥ç«¯å£æˆ– URL" style="flex: 1; width: auto;">
        <button class="scan-btn" onclick="quickAdd()">æ–°å¢åˆ°ä¸»é </button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = 'http://localhost:4567'
    const STORAGE_KEY = 'localtab_config'

    // é¡¯ç¤ºæç¤º
    function showToast(message) {
      const toast = document.getElementById('toast')
      toast.textContent = message
      toast.classList.add('show')
      setTimeout(() => toast.classList.remove('show'), 2000)
    }

    // æª¢æŸ¥ API ç‹€æ…‹
    async function checkApiStatus() {
      const statusEl = document.getElementById('apiStatus')
      try {
        const res = await fetch(`${API_BASE}/health`)
        if (res.ok) {
          statusEl.innerHTML = '<span class="status-dot"></span><span>API é‹ä½œä¸­</span>'
          return true
        }
      } catch (e) {}
      statusEl.innerHTML = '<span class="status-dot offline"></span><span>API é›¢ç·š - è«‹å•Ÿå‹• server</span>'
      return false
    }

    // æƒæå¸¸è¦‹ç«¯å£
    async function scanPorts() {
      const btn = document.getElementById('scanBtn')
      btn.disabled = true
      btn.classList.add('scanning')

      try {
        const res = await fetch(`${API_BASE}/api/ports`)
        const data = await res.json()
        renderPorts(data.ports)
      } catch (e) {
        showToast('æƒæå¤±æ•—ï¼Œè«‹ç¢ºèª API æ˜¯å¦å•Ÿå‹•')
      } finally {
        btn.disabled = false
        btn.classList.remove('scanning')
      }
    }

    // é¡¯ç¤ºæ‰€æœ‰ç«¯å£
    async function scanAllPorts() {
      try {
        const res = await fetch(`${API_BASE}/api/ports/all`)
        const data = await res.json()
        renderPorts(data.ports)
        showToast(`æ‰¾åˆ° ${data.total} å€‹ç«¯å£`)
      } catch (e) {
        showToast('æƒæå¤±æ•—')
      }
    }

    // æ¸²æŸ“ç«¯å£åˆ—è¡¨
    function renderPorts(ports) {
      const grid = document.getElementById('portsGrid')

      if (ports.length === 0) {
        grid.innerHTML = '<div class="empty-state">æ²’æœ‰æ‰¾åˆ°é–‹å•Ÿçš„ç«¯å£</div>'
        return
      }

      // æ”¯æ´æ–°èˆŠæ ¼å¼
      grid.innerHTML = ports.map(p => {
        const port = typeof p === 'number' ? p : p.port
        const process = typeof p === 'object' ? p.process : null
        const pid = typeof p === 'object' ? p.pid : null
        const title = typeof p === 'object' ? p.title : null
        const isHttp = typeof p === 'object' ? p.isHttp : null

        return `
          <div class="port-item">
            <span class="port-number">:${port}</span>
            ${title ? `<div class="port-title">${title}</div>` : ''}
            <div class="port-info">
              ${process ? `<span class="port-process">${process}</span>` : ''}
              ${pid ? `<span>PID: ${pid}</span>` : ''}
              ${isHttp === false ? `<span style="color:#ef4444">é HTTP</span>` : ''}
            </div>
            <div class="port-actions">
              <button class="port-btn" onclick="openPort(${port})">é–‹å•Ÿ</button>
              <button class="port-btn add" onclick="addToMain(${port})">æ–°å¢</button>
            </div>
          </div>
        `
      }).join('')
    }

    // é–‹å•Ÿç«¯å£
    function openPort(port) {
      window.open(`http://localhost:${port}`, '_blank')
    }

    // æ–°å¢åˆ°ä¸»é 
    function addToMain(port) {
      const url = `http://localhost:${port}/`
      addUrlToConfig(url)
    }

    // å¿«é€Ÿæ–°å¢
    function quickAdd() {
      let input = document.getElementById('quickUrl').value.trim()
      if (!input) return

      // å¦‚æœåªæ˜¯æ•¸å­—ï¼Œç•¶æˆç«¯å£
      if (/^\d+$/.test(input)) {
        input = `http://localhost:${input}/`
      } else if (!input.startsWith('http://') && !input.startsWith('https://')) {
        input = 'http://' + input
      }

      addUrlToConfig(input)
      document.getElementById('quickUrl').value = ''
    }

    // æ–°å¢ URL åˆ°é…ç½®
    function addUrlToConfig(url) {
      try {
        const stored = localStorage.getItem(STORAGE_KEY)
        const config = stored ? JSON.parse(stored) : { version: 2, panels: [], layout: 'left' }

        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = config.panels.some(p => p.url === url)
        if (exists) {
          showToast('æ­¤ URL å·²å­˜åœ¨')
          return
        }

        // æ–°å¢é¢æ¿
        const newPanel = {
          id: 'panel_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name: guessNameFromUrl(url),
          url: url,
          unreadCount: 0
        }

        config.panels.push(newPanel)
        config.lastUpdated = new Date().toISOString()

        localStorage.setItem(STORAGE_KEY, JSON.stringify(config))
        showToast(`å·²æ–°å¢ ${newPanel.name}`)
      } catch (e) {
        showToast('æ–°å¢å¤±æ•—')
      }
    }

    // å¾ URL æ¨æ¸¬åç¨±
    function guessNameFromUrl(url) {
      try {
        const u = new URL(url)
        const port = u.port || (u.protocol === 'https:' ? '443' : '80')
        const path = u.pathname !== '/' ? u.pathname.split('/').filter(Boolean)[0] : ''
        return path ? `${port}/${path}` : port
      } catch {
        return 'New'
      }
    }

    // åˆå§‹åŒ–
    checkApiStatus()
    setInterval(checkApiStatus, 10000) // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
  </script>
</body>
</html>
