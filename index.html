<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦–çª—åˆ†å‰²å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é ‚éƒ¨å·¥å…·åˆ— */
    .toolbar {
      background: #16213e;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #0f3460;
      flex-shrink: 0;
    }

    .toolbar h1 {
      font-size: 16px;
      font-weight: 500;
      color: #e94560;
      margin-right: 8px;
    }

    .layout-buttons {
      display: flex;
      gap: 6px;
    }

    .layout-btn {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .layout-btn:hover {
      background: #1a4a7a;
    }

    .layout-btn.active {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .layout-icon {
      display: grid;
      width: 18px;
      height: 14px;
      gap: 1px;
    }

    .layout-icon span {
      background: currentColor;
      border-radius: 1px;
    }

    /* ä½ˆå±€åœ–ç¤º */
    .icon-row { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr; }
    .icon-col { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr; }
    .icon-2x2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
    .icon-left { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; }
    .icon-left span:first-child { grid-row: span 2; }
    .icon-right { grid-template-columns: 1fr 2fr; grid-template-rows: 1fr 1fr; }
    .icon-right span:last-child { grid-row: span 2; }
    .icon-top { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
    .icon-top span:first-child { grid-column: span 2; }
    .icon-tab { grid-template-columns: 1fr; grid-template-rows: 1fr; }

    /* Tab æ¨¡å¼æ¨£å¼ */
    .tab-layout { display: flex; flex-direction: column; flex: 1; }
    .tab-content { flex: 1; display: flex; flex-direction: column; }
    .tab-bar { background: #16213e; border-bottom: 1px solid #0f3460; padding: 8px 12px; display: flex; gap: 6px; flex-wrap: wrap; flex-shrink: 0; }
    .tab-item { background: #0f3460; border: 1px solid #1a4a7a; color: #aaa; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; max-width: 200px; transition: all 0.2s; }
    .tab-item:hover { background: #1a4a7a; color: #eee; }
    .tab-item.active { background: #3b82f6; border-color: #3b82f6; color: white; }
    .tab-item-index { font-weight: bold; min-width: 16px; }
    .tab-item-url { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tab-item-close { background: none; border: none; color: inherit; cursor: pointer; padding: 0; font-size: 14px; opacity: 0.7; }
    .tab-item-close:hover { opacity: 1; }

    .url-manager {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .url-input {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 6px 12px;
      border-radius: 6px;
      width: 280px;
      font-size: 12px;
    }

    .url-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .add-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .add-btn:hover {
      background: #34d399;
    }

    /* ä¸»å®¹å™¨ */
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* é¢æ¿ */
    .panel {
      position: relative;
      min-width: 100px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      background: #16213e;
    }

    .panel-header {
      background: #0f3460;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #aaa;
      flex-shrink: 0;
    }

    .panel-url {
      flex: 1;
      background: #16213e;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    .panel-url:focus {
      outline: none;
      border-color: #3b82f6;
    }

    /* å…¨åŸŸé‡æ–°æ•´ç†æŒ‰éˆ• */
    .reload-all-btn {
      background: #e94560;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      padding: 10px 24px;
      font-size: 15px;
      font-weight: 600;
      margin-left: auto;
      transition: all 0.15s;
    }

    .reload-all-btn:hover {
      background: #ff6b6b;
    }

    .reload-all-btn:active {
      transform: scale(0.95);
    }

    .panel-close {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      font-size: 12px;
    }

    .panel-close:hover {
      color: #ff6b6b;
    }

    .panel iframe {
      flex: 1;
      border: none;
      background: white;
    }

    /* åˆ†å‰²ç·š */
    .divider {
      background: #0f3460;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }

    .divider::after {
      content: '';
      position: absolute;
      background: #3b82f6;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .divider:hover::after,
    .divider.dragging::after {
      opacity: 1;
    }

    .divider-h {
      width: 100%;
      height: 5px;
      cursor: row-resize;
    }

    .divider-h::after {
      left: 0;
      right: 0;
      top: 2px;
      height: 1px;
    }

    .divider-v {
      width: 5px;
      height: 100%;
      cursor: col-resize;
    }

    .divider-v::after {
      top: 0;
      bottom: 0;
      left: 2px;
      width: 1px;
    }

    /* ä½ˆå±€å®¹å™¨ */
    .layout-row {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .layout-col {
      display: flex;
      flex-direction: row;
      flex: 1;
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
    }

    /* é¢æ¿é¸æ“‡å™¨ */
    .panel-selector {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #16213e;
      border: 1px solid #1a4a7a;
      border-radius: 8px;
      padding: 16px;
      z-index: 100;
      display: none;
    }

    .panel-selector.show {
      display: block;
    }

    .panel-selector h3 {
      font-size: 14px;
      margin-bottom: 12px;
      color: #3b82f6;
    }

    .panel-selector-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-selector-item {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .panel-selector-item:hover {
      border-color: #3b82f6;
    }

    /* å¿«æ·éµæç¤º */
    .shortcuts {
      font-size: 11px;
      color: #666;
      display: flex;
      gap: 12px;
    }

    .shortcuts kbd {
      background: #0f3460;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    /* è¨­å®šæŒ‰éˆ•çµ„ */
    .config-buttons {
      display: flex;
      gap: 6px;
    }

    .config-btn {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #aaa;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }

    .config-btn:hover {
      background: #1a4a7a;
      color: #eee;
    }

    .config-btn.danger:hover {
      background: #ef4444;
      border-color: #ef4444;
    }

    /* æç¤ºè¨Šæ¯ */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #16213e;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.success {
      border-color: #4ade80;
    }

    .toast.error {
      border-color: #e94560;
    }

    /* éš±è—çš„æª”æ¡ˆè¼¸å…¥ */
    #importInput {
      display: none;
    }

    /* é€šçŸ¥å¾½ç«  */
    .badge {
      background: #f59e0b;
      color: white;
      font-size: 10px;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      animation: badge-pop 0.3s ease;
    }

    @keyframes badge-pop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .badge.hidden {
      display: none;
    }

    /* é¢æ¿åç¨± */
    .panel-name {
      color: #60a5fa;
      font-weight: bold;
      font-size: 12px;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid transparent;
      min-width: 30px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-name:hover {
      background: #1a4a7a;
    }

    .panel-name-input {
      background: #16213e;
      border: 1px solid #e94560;
      color: #eee;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 3px;
      width: 80px;
    }

    .panel-name-input:focus {
      outline: none;
    }

    /* Tab é …ç›®å¾½ç«  */
    .tab-item .badge {
      margin-left: auto;
    }

    /* å…¨éƒ¨å·²è®€æŒ‰éˆ• */
    .mark-read-btn {
      background: none;
      border: 1px solid #1a4a7a;
      color: #888;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      margin-left: 8px;
    }

    .mark-read-btn:hover {
      border-color: #e94560;
      color: #e94560;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <h1>ğŸªŸ è¦–çª—åˆ†å‰²å™¨</h1>

    <div class="layout-buttons">
      <button class="layout-btn" data-layout="tab" title="åˆ†é æ¨¡å¼">
        <div class="layout-icon icon-tab"><span></span></div>
        åˆ†é 
      </button>
      <button class="layout-btn" data-layout="row" title="ä¸Šä¸‹æ’åˆ—">
        <div class="layout-icon icon-row"><span></span><span></span><span></span></div>
        ä¸Šä¸‹
      </button>
      <button class="layout-btn" data-layout="col" title="å·¦å³æ’åˆ—">
        <div class="layout-icon icon-col"><span></span><span></span><span></span></div>
        å·¦å³
      </button>
      <button class="layout-btn" data-layout="2x2" title="2x2 ç¶²æ ¼">
        <div class="layout-icon icon-2x2"><span></span><span></span><span></span><span></span></div>
        2Ã—2
      </button>
      <button class="layout-btn active" data-layout="left" title="å·¦å´ä¸»è¦–çª—">
        <div class="layout-icon icon-left"><span></span><span></span><span></span></div>
        å·¦ä¸»
      </button>
      <button class="layout-btn" data-layout="right" title="å³å´ä¸»è¦–çª—">
        <div class="layout-icon icon-right"><span></span><span></span><span></span></div>
        å³ä¸»
      </button>
      <button class="layout-btn" data-layout="top" title="é ‚éƒ¨ä¸»è¦–çª—">
        <div class="layout-icon icon-top"><span></span><span></span><span></span></div>
        ä¸Šä¸»
      </button>
    </div>

    <div class="shortcuts">
      <span><kbd>1-9</kbd> åˆ‡æ›é¢æ¿</span>
      <span><kbd>R</kbd> é‡è¼‰</span>
    </div>

    <div class="config-buttons">
      <button class="config-btn" onclick="exportConfig()" title="åŒ¯å‡ºé…ç½®">åŒ¯å‡º</button>
      <button class="config-btn" onclick="triggerImport()" title="åŒ¯å…¥é…ç½®">åŒ¯å…¥</button>
      <button class="config-btn danger" onclick="resetConfig()" title="é‡ç½®ç‚ºé è¨­">é‡ç½®</button>
    </div>

    <div class="url-manager">
      <input type="text" class="url-input" id="urlInput" placeholder="è¼¸å…¥ URLï¼Œå¦‚ http://localhost:3000">
      <button class="add-btn" onclick="addUrl()">+ æ–°å¢</button>
    </div>
  </div>

  <div class="container" id="container"></div>
  <div class="toast" id="toast"></div>
  <input type="file" id="importInput" accept=".json" onchange="importConfig(this.files[0])">

  <script>
    // ==================== é…ç½®ç®¡ç† ====================
    const STORAGE_KEY = 'localtab_config';
    const CONFIG_VERSION = 2;

    // ç”Ÿæˆå”¯ä¸€ ID
    function generateId() {
      return 'panel_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // å¾ URL æ¨æ¸¬åç¨±
    function guessNameFromUrl(url) {
      try {
        const u = new URL(url);
        const port = u.port || (u.protocol === 'https:' ? '443' : '80');
        const path = u.pathname !== '/' ? u.pathname.split('/').filter(Boolean)[0] : '';
        return path ? `${port}/${path}` : port;
      } catch {
        return 'New';
      }
    }

    // å»ºç«‹æ–°é¢æ¿ç‰©ä»¶
    function createPanelData(url, name = null) {
      return {
        id: generateId(),
        name: name || guessNameFromUrl(url),
        url: url,
        unreadCount: 0
      };
    }

    // é è¨­é…ç½®
    const DEFAULT_CONFIG = {
      version: CONFIG_VERSION,
      panels: [
        createPanelData('http://localhost:3000/')
      ],
      layout: 'left',
      lastUpdated: null
    };

    // ç•¶å‰ç‹€æ…‹
    let panels = [];
    let currentLayout = 'left';
    let activeTabIndex = 0;
    let focusedPanelId = null;
    let panelSizes = {};

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    // å„²å­˜é…ç½®åˆ° localStorage
    function saveConfig() {
      try {
        const config = {
          version: CONFIG_VERSION,
          panels: panels.map(p => ({ ...p, unreadCount: 0 })), // ä¸å„²å­˜æœªè®€æ•¸
          layout: currentLayout,
          lastUpdated: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      } catch (e) {
        console.warn('ç„¡æ³•å„²å­˜é…ç½®:', e);
      }
    }

    // å¾ localStorage è¼‰å…¥é…ç½®ï¼ˆå«ç‰ˆæœ¬é·ç§»ï¼‰
    function loadConfig() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const config = JSON.parse(stored);

          // ç‰ˆæœ¬ 1 é·ç§»åˆ°ç‰ˆæœ¬ 2
          if (config.version === 1 && config.urls) {
            panels = config.urls.map(url => createPanelData(url));
            currentLayout = config.layout || DEFAULT_CONFIG.layout;
            saveConfig(); // å„²å­˜æ–°æ ¼å¼
            return true;
          }

          // ç‰ˆæœ¬ 2
          if (config.version === CONFIG_VERSION && config.panels) {
            panels = config.panels.map(p => ({ ...p, unreadCount: 0 }));
            currentLayout = config.layout || DEFAULT_CONFIG.layout;
            return true;
          }
        }
      } catch (e) {
        console.warn('ç„¡æ³•è¼‰å…¥é…ç½®:', e);
      }
      // ä½¿ç”¨é è¨­å€¼
      panels = DEFAULT_CONFIG.panels.map(p => ({ ...p }));
      currentLayout = DEFAULT_CONFIG.layout;
      return false;
    }

    // åŒ¯å‡ºé…ç½®ç‚º JSON æª”æ¡ˆ
    function exportConfig() {
      const config = {
        version: CONFIG_VERSION,
        panels: panels.map(p => ({ id: p.id, name: p.name, url: p.url })),
        layout: currentLayout,
        lastUpdated: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'localtab-config.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('é…ç½®å·²åŒ¯å‡º');
    }

    // è§¸ç™¼æª”æ¡ˆé¸æ“‡
    function triggerImport() {
      document.getElementById('importInput').click();
    }

    // å¾ JSON æª”æ¡ˆåŒ¯å…¥é…ç½®
    function importConfig(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const config = JSON.parse(e.target.result);
          // æ”¯æ´æ–°èˆŠæ ¼å¼
          if (config.panels && Array.isArray(config.panels)) {
            panels = config.panels.map(p => ({ ...p, unreadCount: 0 }));
          } else if (config.urls && Array.isArray(config.urls)) {
            panels = config.urls.map(url => createPanelData(url));
          } else {
            throw new Error('ç„¡æ•ˆçš„é…ç½®æ ¼å¼');
          }
          currentLayout = config.layout || 'left';
          saveConfig();
          renderLayout();
          updateLayoutButtons();
          showToast('é…ç½®å·²åŒ¯å…¥');
        } catch (err) {
          showToast('åŒ¯å…¥å¤±æ•—: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      document.getElementById('importInput').value = '';
    }

    // é‡ç½®ç‚ºé è¨­é…ç½®
    function resetConfig() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®é…ç½®å—ï¼Ÿæ‰€æœ‰å„²å­˜çš„é¢æ¿å°‡è¢«æ¸…é™¤ã€‚')) return;
      panels = DEFAULT_CONFIG.panels.map(p => ({ ...p }));
      currentLayout = DEFAULT_CONFIG.layout;
      saveConfig();
      renderLayout();
      updateLayoutButtons();
      showToast('å·²é‡ç½®ç‚ºé è¨­é…ç½®');
    }

    // ==================== é€šçŸ¥åŠŸèƒ½ ====================
    const POLL_INTERVAL = 5000; // 5 ç§’æª¢æŸ¥ä¸€æ¬¡
    let pollTimer = null;
    let panelFingerprints = {}; // å„²å­˜æ¯å€‹ URL çš„ fingerprint

    // æª¢æŸ¥å–®ä¸€ URL æ˜¯å¦æœ‰æ›´æ–°
    async function checkUrlUpdate(panelData) {
      try {
        const res = await fetch(panelData.url, {
          method: 'HEAD',
          cache: 'no-store'
        });

        // å„ªå…ˆç”¨ ETagï¼Œå…¶æ¬¡ Last-Modifiedï¼Œæœ€å¾Œç”¨ Content-Length
        const etag = res.headers.get('ETag');
        const lastModified = res.headers.get('Last-Modified');
        const contentLength = res.headers.get('Content-Length');
        const fingerprint = etag || lastModified || contentLength || '';

        const oldFingerprint = panelFingerprints[panelData.id];
        panelFingerprints[panelData.id] = fingerprint;

        // é¦–æ¬¡æª¢æŸ¥ä¸ç®—æ›´æ–°
        if (oldFingerprint === undefined) return false;

        // fingerprint è®ŠåŒ– = æœ‰æ›´æ–°
        if (fingerprint && fingerprint !== oldFingerprint) {
          return true;
        }
        return false;
      } catch (e) {
        // è«‹æ±‚å¤±æ•—ï¼ˆæœå‹™æœªå•Ÿå‹•ç­‰ï¼‰ï¼Œå¿½ç•¥
        return false;
      }
    }

    // æª¢æŸ¥æ‰€æœ‰é¢æ¿æ›´æ–°
    async function checkAllUpdates() {
      for (const panelData of panels) {
        const hasUpdate = await checkUrlUpdate(panelData);
        if (hasUpdate) {
          incrementUnread(panelData.id);
        }
      }
    }

    // é–‹å§‹è¼ªè©¢
    function startPolling() {
      if (pollTimer) return;
      // å…ˆåšä¸€æ¬¡åˆå§‹æª¢æŸ¥ï¼ˆå»ºç«‹ fingerprintï¼‰
      checkAllUpdates();
      // å®šæ™‚æª¢æŸ¥
      pollTimer = setInterval(checkAllUpdates, POLL_INTERVAL);
    }

    // åœæ­¢è¼ªè©¢
    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    // å¢åŠ æœªè®€è¨ˆæ•¸
    function incrementUnread(panelId) {
      const panel = panels.find(p => p.id === panelId);
      if (panel && panelId !== focusedPanelId) {
        panel.unreadCount++;
        updateBadges();
      }
    }

    // æ¸…é™¤æœªè®€è¨ˆæ•¸
    function clearUnread(panelId) {
      const panel = panels.find(p => p.id === panelId);
      if (panel && panel.unreadCount > 0) {
        panel.unreadCount = 0;
        updateBadges();
      }
    }

    // å…¨éƒ¨å·²è®€
    function markAllRead() {
      panels.forEach(p => p.unreadCount = 0);
      updateBadges();
    }

    // å–å¾—ç¸½æœªè®€æ•¸
    function getTotalUnread() {
      return panels.reduce((sum, p) => sum + p.unreadCount, 0);
    }

    // æ›´æ–°æ‰€æœ‰å¾½ç« 
    function updateBadges() {
      // æ›´æ–° tab é …ç›®å¾½ç« 
      document.querySelectorAll('.tab-item').forEach((item, i) => {
        const badge = item.querySelector('.badge');
        if (badge && panels[i]) {
          const count = panels[i].unreadCount;
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.toggle('hidden', count === 0);
        }
      });

      // æ›´æ–°é¢æ¿å¾½ç« 
      document.querySelectorAll('.panel').forEach((panel, i) => {
        const badge = panel.querySelector('.badge');
        if (badge && panels[i]) {
          const count = panels[i].unreadCount;
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.toggle('hidden', count === 0);
        }
      });

      // æ›´æ–°é é¢æ¨™é¡Œ
      const total = getTotalUnread();
      document.title = total > 0 ? `(${total}) è¦–çª—åˆ†å‰²å™¨` : 'è¦–çª—åˆ†å‰²å™¨';
    }

    // æ›´æ–°ä½ˆå±€æŒ‰éˆ•ç‹€æ…‹
    function updateLayoutButtons() {
      document.querySelectorAll('.layout-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.layout === currentLayout);
      });
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      loadConfig();
      renderLayout();
      setupLayoutButtons();
      setupKeyboard();
      startPolling(); // é–‹å§‹æª¢æŸ¥æ›´æ–°
    }

    // è¨­å®šä½ˆå±€æŒ‰éˆ•
    function setupLayoutButtons() {
      document.querySelectorAll('.layout-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentLayout = btn.dataset.layout;
          saveConfig(); // è‡ªå‹•å„²å­˜
          renderLayout();
        });
      });
      updateLayoutButtons();
    }

    // éµç›¤å¿«æ·éµ
    function setupKeyboard() {
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.key >= '1' && e.key <= '9') {
          const index = parseInt(e.key) - 1;
          if (currentLayout === 'tab') {
            if (index < panels.length) {
              activeTabIndex = index;
              focusedPanelId = panels[index].id;
              clearUnread(focusedPanelId);
              renderLayout();
            }
          } else {
            const panel = document.querySelectorAll('.panel')[index];
            if (panel) {
              panel.querySelector('iframe')?.focus();
              if (panels[index]) {
                focusedPanelId = panels[index].id;
                clearUnread(focusedPanelId);
              }
            }
          }
        }
        if (currentLayout === 'tab') {
          if (e.key === 'ArrowLeft') {
            activeTabIndex = (activeTabIndex - 1 + panels.length) % panels.length;
            focusedPanelId = panels[activeTabIndex].id;
            clearUnread(focusedPanelId);
            renderLayout();
          } else if (e.key === 'ArrowRight') {
            activeTabIndex = (activeTabIndex + 1) % panels.length;
            focusedPanelId = panels[activeTabIndex].id;
            clearUnread(focusedPanelId);
            renderLayout();
          }
        }
        if (e.key.toLowerCase() === 'r') {
          if (currentLayout === 'tab') {
            const iframe = document.querySelector('.tab-content iframe');
            if (iframe) iframe.src = iframe.src;
          } else {
            document.querySelectorAll('.panel iframe').forEach(iframe => { iframe.src = iframe.src; });
          }
        }
      });
    }

    // å»ºç«‹é¢æ¿
    function createPanel(panelData, index) {
      const panel = document.createElement('div');
      panel.className = 'panel';
      panel.dataset.panelId = panelData.id;

      const unreadCount = panelData.unreadCount || 0;
      const badgeClass = unreadCount === 0 ? 'badge hidden' : 'badge';
      const badgeText = unreadCount > 99 ? '99+' : unreadCount;

      panel.innerHTML = `
        <div class="panel-header">
          <div class="panel-name" ondblclick="startEditName(${index}, this)" title="é›™æ“Šç·¨è¼¯åç¨±">
            <span>${panelData.name}</span>
            <span class="${badgeClass}">${badgeText}</span>
          </div>
          <input type="text" class="panel-url" value="${panelData.url}" onchange="updateUrl(${index}, this.value)" onkeydown="if(event.key==='Enter')this.blur()">
          <button class="panel-reload" onclick="reloadPanel(${index})" title="é‡æ–°è¼‰å…¥">â†» é‡æ•´</button>
          <button class="panel-close" onclick="removePanel(${index})" title="é—œé–‰">âœ•</button>
        </div>
        <iframe src="${panelData.url}" title="${panelData.name}"></iframe>
      `;

      // é»æ“Šé¢æ¿æ™‚æ¸…é™¤æœªè®€
      panel.addEventListener('click', () => {
        focusedPanelId = panelData.id;
        clearUnread(panelData.id);
      });

      return panel;
    }

    // é–‹å§‹ç·¨è¼¯åç¨±
    function startEditName(index, element) {
      const panelData = panels[index];
      const currentName = panelData.name;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'panel-name-input';
      input.value = currentName;

      const finishEdit = () => {
        const newName = input.value.trim() || currentName;
        panelData.name = newName;
        saveConfig();
        renderLayout();
      };

      input.addEventListener('blur', finishEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') { input.value = currentName; input.blur(); }
      });

      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    // å»ºç«‹åˆ†å‰²ç·š
    function createDivider(type, index) {
      const divider = document.createElement('div');
      divider.className = `divider divider-${type}`;
      divider.dataset.index = index;
      
      divider.addEventListener('mousedown', (e) => {
        e.preventDefault();
        startDrag(divider, type);
      });

      return divider;
    }

    // æ‹–æ›³èª¿æ•´å¤§å°
    function startDrag(divider, type) {
      divider.classList.add('dragging');
      const container = divider.parentElement;
      const children = Array.from(container.children).filter(c => c.classList.contains('panel') || c.classList.contains('layout-row') || c.classList.contains('layout-col'));
      const dividerIndex = Array.from(container.children).filter(c => c.classList.contains('divider')).indexOf(divider);
      
      const before = children[dividerIndex];
      const after = children[dividerIndex + 1];
      
      if (!before || !after) return;

      const isVertical = type === 'v';
      const containerRect = container.getBoundingClientRect();
      const totalSize = isVertical ? containerRect.width : containerRect.height;

      const startPos = isVertical ? event.clientX : event.clientY;
      const beforeSize = isVertical ? before.offsetWidth : before.offsetHeight;
      const afterSize = isVertical ? after.offsetWidth : after.offsetHeight;

      function onMove(e) {
        const currentPos = isVertical ? e.clientX : e.clientY;
        const delta = currentPos - startPos;
        
        const newBeforeSize = Math.max(100, beforeSize + delta);
        const newAfterSize = Math.max(100, afterSize - delta);
        
        const totalNew = newBeforeSize + newAfterSize;
        before.style.flex = `${newBeforeSize / totalNew}`;
        after.style.flex = `${newAfterSize / totalNew}`;
      }

      function onUp() {
        divider.classList.remove('dragging');
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    // æ¸²æŸ“ä½ˆå±€
    function renderLayout() {
      const container = document.getElementById('container');
      container.innerHTML = '';

      if (panels.length === 0) {
        container.innerHTML = '<div class="empty-state">é»æ“Šä¸‹æ–¹ã€Œ+ æ–°å¢ã€åŠ å…¥ URL</div>';
        return;
      }

      switch (currentLayout) {
        case 'tab':
          renderTabLayout(container);
          break;
        case 'row':
          renderRowLayout(container);
          break;
        case 'col':
          renderColLayout(container);
          break;
        case '2x2':
          render2x2Layout(container);
          break;
        case 'left':
          renderLeftLayout(container);
          break;
        case 'right':
          renderRightLayout(container);
          break;
        case 'top':
          renderTopLayout(container);
          break;
      }
    }

    // åˆ†é æ¨¡å¼
    function renderTabLayout(container) {
      if (activeTabIndex >= panels.length) activeTabIndex = panels.length - 1;
      if (activeTabIndex < 0) activeTabIndex = 0;

      const wrapper = document.createElement('div');
      wrapper.className = 'tab-layout';

      // åˆ†é åˆ—
      const tabBar = document.createElement('div');
      tabBar.className = 'tab-bar';

      panels.forEach((panelData, i) => {
        const unreadCount = panelData.unreadCount || 0;
        const badgeClass = unreadCount === 0 ? 'badge hidden' : 'badge';
        const badgeText = unreadCount > 99 ? '99+' : unreadCount;

        const tabItem = document.createElement('div');
        tabItem.className = 'tab-item' + (i === activeTabIndex ? ' active' : '');
        tabItem.innerHTML = `
          <span class="tab-item-index">${i + 1}</span>
          <span class="tab-item-url" title="${panelData.url}">${panelData.name}</span>
          <span class="${badgeClass}">${badgeText}</span>
          <button class="tab-item-close" onclick="event.stopPropagation(); removePanel(${i})">âœ•</button>
        `;
        tabItem.addEventListener('click', () => {
          activeTabIndex = i;
          focusedPanelId = panelData.id;
          clearUnread(panelData.id);
          renderLayout();
        });
        tabBar.appendChild(tabItem);
      });

      // å…¨éƒ¨å·²è®€æŒ‰éˆ•
      if (getTotalUnread() > 0) {
        const markReadBtn = document.createElement('button');
        markReadBtn.className = 'mark-read-btn';
        markReadBtn.textContent = 'å…¨éƒ¨å·²è®€';
        markReadBtn.onclick = markAllRead;
        tabBar.appendChild(markReadBtn);
      }

      // é‡æ–°æ•´ç†æŒ‰éˆ•ï¼ˆæ”¾å³é‚Šï¼‰
      const reloadBtn = document.createElement('button');
      reloadBtn.className = 'reload-all-btn';
      reloadBtn.textContent = 'â†» é‡æ–°æ•´ç†';
      reloadBtn.onclick = () => reloadPanel(activeTabIndex);
      tabBar.appendChild(reloadBtn);

      wrapper.appendChild(tabBar);

      // å…§å®¹å€åŸŸ
      const content = document.createElement('div');
      content.className = 'tab-content';
      const panel = createPanel(panels[activeTabIndex], activeTabIndex);
      panel.style.flex = '1';
      content.appendChild(panel);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    }

    // ä¸Šä¸‹æ’åˆ—
    function renderRowLayout(container) {
      const wrapper = document.createElement('div');
      wrapper.className = 'layout-row';
      wrapper.style.cssText = 'display: flex; flex-direction: column; flex: 1;';

      panels.forEach((panelData, i) => {
        if (i > 0) wrapper.appendChild(createDivider('h', i - 1));
        const panel = createPanel(panelData, i);
        panel.style.flex = '1';
        wrapper.appendChild(panel);
      });

      container.appendChild(wrapper);
    }

    // å·¦å³æ’åˆ—
    function renderColLayout(container) {
      const wrapper = document.createElement('div');
      wrapper.className = 'layout-col';
      wrapper.style.cssText = 'display: flex; flex-direction: row; flex: 1;';

      panels.forEach((panelData, i) => {
        if (i > 0) wrapper.appendChild(createDivider('v', i - 1));
        const panel = createPanel(panelData, i);
        panel.style.flex = '1';
        wrapper.appendChild(panel);
      });

      container.appendChild(wrapper);
    }

    // 2x2 ç¶²æ ¼
    function render2x2Layout(container) {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'display: flex; flex-direction: column; flex: 1;';

      // ä¸Šæ’
      const topRow = document.createElement('div');
      topRow.style.cssText = 'display: flex; flex: 1;';

      if (panels[0]) {
        const p = createPanel(panels[0], 0);
        p.style.flex = '1';
        topRow.appendChild(p);
      }
      if (panels[1]) {
        topRow.appendChild(createDivider('v', 0));
        const p = createPanel(panels[1], 1);
        p.style.flex = '1';
        topRow.appendChild(p);
      }
      wrapper.appendChild(topRow);

      // åˆ†å‰²ç·š
      if (panels.length > 2) {
        wrapper.appendChild(createDivider('h', 0));

        // ä¸‹æ’
        const bottomRow = document.createElement('div');
        bottomRow.style.cssText = 'display: flex; flex: 1;';

        if (panels[2]) {
          const p = createPanel(panels[2], 2);
          p.style.flex = '1';
          bottomRow.appendChild(p);
        }
        if (panels[3]) {
          bottomRow.appendChild(createDivider('v', 1));
          const p = createPanel(panels[3], 3);
          p.style.flex = '1';
          bottomRow.appendChild(p);
        }
        wrapper.appendChild(bottomRow);
      }

      container.appendChild(wrapper);
    }

    // å·¦å´ä¸»è¦–çª—
    function renderLeftLayout(container) {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'display: flex; flex: 1;';

      // å·¦å´ä¸»é¢æ¿
      if (panels[0]) {
        const main = createPanel(panels[0], 0);
        main.style.flex = '2';
        wrapper.appendChild(main);
      }

      // å³å´å †ç–Š
      if (panels.length > 1) {
        wrapper.appendChild(createDivider('v', 0));

        const sidebar = document.createElement('div');
        sidebar.style.cssText = 'display: flex; flex-direction: column; flex: 1;';

        panels.slice(1).forEach((panelData, i) => {
          if (i > 0) sidebar.appendChild(createDivider('h', i));
          const p = createPanel(panelData, i + 1);
          p.style.flex = '1';
          sidebar.appendChild(p);
        });

        wrapper.appendChild(sidebar);
      }

      container.appendChild(wrapper);
    }

    // å³å´ä¸»è¦–çª—
    function renderRightLayout(container) {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'display: flex; flex: 1;';

      // å·¦å´å †ç–Š
      if (panels.length > 1) {
        const sidebar = document.createElement('div');
        sidebar.style.cssText = 'display: flex; flex-direction: column; flex: 1;';

        panels.slice(1).forEach((panelData, i) => {
          if (i > 0) sidebar.appendChild(createDivider('h', i));
          const p = createPanel(panelData, i + 1);
          p.style.flex = '1';
          sidebar.appendChild(p);
        });

        wrapper.appendChild(sidebar);
        wrapper.appendChild(createDivider('v', 0));
      }

      // å³å´ä¸»é¢æ¿
      if (panels[0]) {
        const main = createPanel(panels[0], 0);
        main.style.flex = '2';
        wrapper.appendChild(main);
      }

      container.appendChild(wrapper);
    }

    // é ‚éƒ¨ä¸»è¦–çª—
    function renderTopLayout(container) {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'display: flex; flex-direction: column; flex: 1;';

      // é ‚éƒ¨ä¸»é¢æ¿
      if (panels[0]) {
        const main = createPanel(panels[0], 0);
        main.style.flex = '2';
        wrapper.appendChild(main);
      }

      // åº•éƒ¨ä¸¦æ’
      if (panels.length > 1) {
        wrapper.appendChild(createDivider('h', 0));

        const bottomRow = document.createElement('div');
        bottomRow.style.cssText = 'display: flex; flex: 1;';

        panels.slice(1).forEach((panelData, i) => {
          if (i > 0) bottomRow.appendChild(createDivider('v', i));
          const p = createPanel(panelData, i + 1);
          p.style.flex = '1';
          bottomRow.appendChild(p);
        });

        wrapper.appendChild(bottomRow);
      }

      container.appendChild(wrapper);
    }

    // æ–°å¢é¢æ¿
    function addUrl() {
      const input = document.getElementById('urlInput');
      let url = input.value.trim();
      if (!url) return;
      if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'http://' + url;
      panels.push(createPanelData(url));
      input.value = '';
      if (currentLayout === 'tab') activeTabIndex = panels.length - 1;
      saveConfig();
      renderLayout();
    }

    // æ›´æ–° URL
    function updateUrl(index, newUrl) {
      if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
        newUrl = 'http://' + newUrl;
      }
      if (panels[index]) {
        panels[index].url = newUrl;
        saveConfig();
        let iframe;
        if (currentLayout === 'tab') {
          iframe = document.querySelector('.panel iframe');
        } else {
          iframe = document.querySelectorAll('.panel iframe')[index];
        }
        if (iframe) iframe.src = newUrl;
      }
    }

    // ç§»é™¤é¢æ¿
    function removePanel(index) {
      const panelId = panels[index]?.id;
      if (panelId) {
        delete panelFingerprints[panelId];
      }
      panels.splice(index, 1);
      if (currentLayout === 'tab' && activeTabIndex >= panels.length) {
        activeTabIndex = Math.max(0, panels.length - 1);
      }
      saveConfig();
      renderLayout();
    }

    // é‡è¼‰é¢æ¿
    function reloadPanel(index) {
      let iframe;
      if (currentLayout === 'tab') {
        // åˆ†é æ¨¡å¼ä¸‹åªæœ‰ä¸€å€‹ panel
        iframe = document.querySelector('.panel iframe');
      } else {
        iframe = document.querySelectorAll('.panel iframe')[index];
      }
      if (iframe) iframe.src = iframe.src;
    }

    // Enter éµæ–°å¢
    document.getElementById('urlInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addUrl();
    });

    // å•Ÿå‹•
    init();
  </script>
</body>
</html>